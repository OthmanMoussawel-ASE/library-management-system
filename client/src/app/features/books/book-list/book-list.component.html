<div class="book-list-container">
  <div class="header-row">
    <div class="search-group">
      @if (!smartSearchMode) {
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search books</mat-label>
          <input
            matInput
            placeholder="Search by title, author..."
            (input)="onSearchChange($any($event.target).value)"
          />
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>
      } @else {
        <mat-form-field appearance="outline" class="search-field smart-search-field">
          <mat-label>AI Smart Search</mat-label>
          <input
            matInput
            #smartInput
            placeholder="e.g. mystery books by British authors"
            (keyup.enter)="onSmartSearch(smartInput.value)"
          />
          <mat-icon matPrefix>auto_awesome</mat-icon>
          <button
            mat-icon-button
            matSuffix
            (click)="onSmartSearch(smartInput.value)"
            [disabled]="isSmartSearching"
            matTooltip="Search"
          >
            <mat-icon>{{ isSmartSearching ? 'hourglass_empty' : 'search' }}</mat-icon>
          </button>
        </mat-form-field>
      }
      <button
        mat-icon-button
        [color]="smartSearchMode ? 'accent' : 'primary'"
        (click)="toggleSmartSearch()"
        [matTooltip]="smartSearchMode ? 'Switch to regular search' : 'Switch to AI smart search'"
      >
        <mat-icon>{{ smartSearchMode ? 'search' : 'auto_awesome' }}</mat-icon>
      </button>
    </div>
    @if (isLibrarian) {
      <button
        mat-fab
        color="primary"
        class="add-fab"
        [routerLink]="['/books', 'create']"
        matTooltip="Add Book"
      >
        <mat-icon>add</mat-icon>
      </button>
    }
  </div>

  <div class="table-wrapper">
    <table mat-table [dataSource]="dataSource" matSort (matSortChange)="onSortChange($event)">
      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Title</th>
        <td mat-cell *matCellDef="let book">
          <a [routerLink]="['/books', book.id]" class="book-title-link">{{ book.title }}</a>
        </td>
      </ng-container>

      <ng-container matColumnDef="authorName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Author</th>
        <td mat-cell *matCellDef="let book">{{ book.authorName }}</td>
      </ng-container>

      <ng-container matColumnDef="availableCopies">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Available</th>
        <td mat-cell *matCellDef="let book">{{ book.availableCopies }} / {{ book.totalCopies }}</td>
      </ng-container>

      <ng-container matColumnDef="categories">
        <th mat-header-cell *matHeaderCellDef>Categories</th>
        <td mat-cell *matCellDef="let book">
          <mat-chip-set>
            @for (cat of book.categories; track cat) {
              <mat-chip>{{ cat }}</mat-chip>
            }
            @if (book.categories.length === 0) {
              <span class="no-categories">â€”</span>
            }
          </mat-chip-set>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let book">
          <div class="action-buttons">
            @if (book.availableCopies > 0) {
              <button
                mat-icon-button
                color="primary"
                (click)="checkout(book)"
                matTooltip="Checkout"
              >
                <mat-icon>menu_book</mat-icon>
              </button>
            }
            @if (isLibrarian) {
              <button
                mat-icon-button
                [routerLink]="['/books', book.id, 'edit']"
                matTooltip="Edit"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                (click)="deleteBook(book)"
                matTooltip="Delete"
              >
                <mat-icon>delete</mat-icon>
              </button>
            }
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <div class="no-data">
            @if (isLoading) {
              <mat-spinner diameter="32"></mat-spinner>
              <span>Loading books...</span>
            } @else {
              <mat-icon>menu_book</mat-icon>
              <span>No books found</span>
            }
          </div>
        </td>
      </tr>
    </table>

    <mat-paginator
      [length]="totalCount"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="[5, 10, 25, 50]"
      (page)="onPageChange($event)"
      showFirstLastButtons
    >
    </mat-paginator>
  </div>
</div>
